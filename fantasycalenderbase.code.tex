
%\ProvidesFileRCS{fantasycalendar.code.tex}
\makeatletter

\@ifpackageloaded{pgf}{}
  {\RequirePackage{pgf}}
\@ifpackageloaded{l3benchmark}{}
  {\RequirePackage{l3benchmark}}


\ExplSyntaxOn


\int_new:N \l__fantasycal_base_default_nr_days_per_year_int
\int_new:N \l__fantasycal_base_nr_days_per_year_int
\int_new:N \l__fantasycal_base_nr_months_per_year_int
\int_new:N \l__fantasycal_base_nr_days_per_week_int

\int_new:N \l__fantasycal_base_tmpa_int
\int_new:N \l__fantasycal_base_tmpb_int

\int_new:N \g__fantasycal_base_tmpa_int
\int_new:N \g__fantasycal_base_tmpb_int
\int_new:N \g__fantasycal_base_tmpc_int

\tl_new:N \l__fantasycal_base_tmpa_tl
\tl_new:N \l__fantasycal_base_tmpb_tl

\int_new:N \l__fantasycal_base_year_int
\int_new:N \l__fantasycal_base_month_int
\int_new:N \l__fantasycal_base_day_int
\int_new:N \l__fantasycal_base_zero_day_shift_int

\int_new:N \l__fantasycal_base_month_at_half_year_int
\int_new:N \l__fantasycal_base_nr_days_of_half_year_int


\seq_new:N \l__fantasycal_base_day_names_seq
\seq_new:N \l__fantasycal_base_month_names_seq
\seq_new:N \l__fantasycal_base_default_number_days_of_months_seq
\seq_new:N \l__fantasycal_base_number_days_of_months_seq
\seq_new:N \l__fantasycal_base_cumulative_number_days_seq
\seq_new:N \l__fantasycal_base_cumulative_number_days_invers_seq
\seq_new:N \l__fantasycal_base_default_cumulative_number_days_seq
\seq_new:N \l__fantasycal_base_default_cumulative_number_days_invers_seq

\bool_new:N \l__fantasycal_base_date_match_bool


\int_new:N \l_fantasycal_base_weekday_int
\int_new:N \l_fantasycal_base_current_ordinal_int

\tl_new:N \l_fantasycal_base_current_weekday_tl


\tl_new:N \l__fantasycal_base_calendar_prefix_tl
\tl_new:N \l__fantasycal_base_begin_ordinal_tl
\tl_new:N \l__fantasycal_base_end_ordinal_tl
\tl_new:N \l__fantasycal_base_end_ordinal_plus_tl
\tl_new:N \l__fantasycal_base_begin_iso_tl
\tl_new:N \l__fantasycal_base_end_iso_tl

\tl_new:N \l_fantasycal_base_current_year_tl
\tl_new:N \l_fantasycal_base_current_month_tl
\tl_new:N \l_fantasycal_base_current_day_tl

\tl_new:N \l__fantasycal_base_hook_tl
\NewDocumentCommand \basefantasycalendaraddhook { +m }
  {
    \tl_put_right:Nn \l__fantasycal_base_hook_tl {#1}
  }

%% Main command to print calendar. Stolen from tikz' calendar

\NewDocumentCommand \basefantasycalendar { m m m +m }
  {
    \__fantasycal_base_fantasycalendar:nnnn {#1} {#2} {#3} {#4}
  }

\cs_new:Npn \__fantasycal_base_fantasycalendar:nnnn #1#2#3#4
  {
    \group_begin:
%    % Setup local \ifdate
      \cs_set_eq:NN \ifdate \__fantasycal_base_if_date:nTF
      \cs_set_eq:NN \ifdateTF \__fantasycal_base_if_date:nTF
      \cs_set_eq:NN \ifdateT \__fantasycal_base_if_date:nT
      \cs_set_eq:NN \ifdateF \__fantasycal_base_if_date:nF
%    % Let's start with computing start and end dates...
      \tl_set:Nn \l__fantasycal_base_calendar_prefix_tl {#1}
      \tl_set:Nx \l__fantasycal_base_begin_iso_tl {#2}
      \tl_set:Nx \l__fantasycal_base_end_iso_tl {#3}
%
      \__fantasycal_base_iso_to_ordinal:nN {#2} \l_fantasycal_base_current_ordinal_int
      \__fantasycal_base_iso_to_ordinal:nN {#3} \l__fantasycal_base_tmpa_int
%
      \tl_set:NV \l__fantasycal_base_begin_ordinal_tl \l_fantasycal_base_current_ordinal_int
      \tl_set:NV \l__fantasycal_base_end_ordinal_tl \l__fantasycal_base_tmpa_int
      \int_incr:N \l__fantasycal_base_tmpa_int
      \tl_set:NV \l__fantasycal_base_end_ordinal_plus_tl \l__fantasycal_base_tmpa_int
    %
    % Start main loop
    %
      \int_while_do:nNnn { \l_fantasycal_base_current_ordinal_int } <
        { \l__fantasycal_base_end_ordinal_plus_tl }
        {
          % Setup information aout current year (leap year)
          % and change some variables accordingly!
          \__fantasycal_base_check_and_setup_leap_year:nN 
            { \l_fantasycal_base_current_ordinal_int }
            \l_fantasycal_base_current_year_tl
          % Setup information about current date
          \__fantasycal_base_ordinal_to_date_shorter:nNNN
            { \l_fantasycal_base_current_ordinal_int }
            \l_fantasycal_base_current_year_tl
            \l_fantasycal_base_current_month_tl
            \l_fantasycal_base_current_day_tl
          \__fantasycal_base_ordinal_to_weekday:nN 
            {\l_fantasycal_base_current_ordinal_int}
            \l_fantasycal_base_weekday_int
          \tl_set:NV \l_fantasycal_base_current_weekday_tl \l_fantasycal_base_weekday_int
          \l__fantasycal_base_hook_tl
          % Render:
          #4
          % Advance day:
          \int_incr:N \l_fantasycal_base_current_ordinal_int
        }
    \group_end:
  }



%% Defenition of months

\NewDocumentCommand \FantasyCalendarAddMonths { m m }
  {
    \__fantasycal_base_set_first_day_shift:n {#1}
    \__fantasycal_base_add_list_of_months:n {#2}
    \__fantasycal_base_define_month_at_half_year:NN 
      \l__fantasycal_base_nr_months_per_year_int
      \l__fantasycal_base_cumulative_number_days_seq
  }

\cs_new:Npn \__fantasycal_base_set_first_day_shift:n #1
  {
    \int_set:Nn \l__fantasycal_base_zero_day_shift_int {#1}
  }

\cs_new:Npn \__fantasycal_base_add_list_of_months:n #1
  {
    \__fantasycal_base_add_list_of_months_setup:
%    
    \keyval_parse:NNn
      \__fantasycal_base_parse_keys_error:n
      \__fantasycal_base_parse_keys:nn
      {#1}
%
    \__fantasycal_base_add_list_of_months_finish:
  }

\cs_new:Npn \__fantasycal_base_parse_keys_error:n #1
  {
    \tl_show:n {ERROR! No ~number ~of ~days ~ given! -- #1}
  }
\cs_new:Npn \__fantasycal_base_parse_keys:nn #1#2
  {
    %% count months
    \int_incr:N \l__fantasycal_base_nr_months_per_year_int
    %% Get names of months
    \seq_put_right:Nn \l__fantasycal_base_month_names_seq {#1}
    %% Set values
    \int_set:Nn \l_tmpa_int {#2}
    \seq_put_right:NV \l__fantasycal_base_number_days_of_months_seq \l_tmpa_int
    \seq_put_right:NV \l__fantasycal_base_cumulative_number_days_seq 
      \l__fantasycal_base_default_nr_days_per_year_int
    \seq_put_left:NV \l__fantasycal_base_cumulative_number_days_invers_seq
      \l__fantasycal_base_default_nr_days_per_year_int
    \int_add:Nn \l__fantasycal_base_default_nr_days_per_year_int { \l_tmpa_int }
  }


\cs_new:Npn \__fantasycal_base_add_list_of_months_setup:
  {
    \int_zero:N \l__fantasycal_base_nr_months_per_year_int
    \int_zero:N \l__fantasycal_base_default_nr_days_per_year_int
    \seq_clear:N \l__fantasycal_base_month_names_seq
    \seq_clear:N \l__fantasycal_base_number_days_of_months_seq
    \seq_clear:N \l__fantasycal_base_cumulative_number_days_seq
    \seq_clear:N \l__fantasycal_base_cumulative_number_days_invers_seq  
  }

\cs_new:Npn \__fantasycal_base_add_list_of_months_finish:
  {
    \seq_set_eq:NN \l__fantasycal_base_default_cumulative_number_days_invers_seq 
      \l__fantasycal_base_cumulative_number_days_invers_seq
    \seq_set_eq:NN \l__fantasycal_base_default_number_days_of_months_seq
      \l__fantasycal_base_number_days_of_months_seq
    \int_set_eq:NN \l__fantasycal_base_nr_days_per_year_int 
      \l__fantasycal_base_default_nr_days_per_year_int
    \seq_set_eq:NN \l__fantasycal_base_default_cumulative_number_days_seq 
      \l__fantasycal_base_cumulative_number_days_seq      
  }
  
\cs_new:Npn \__fantasycal_base_define_month_at_half_year:NN #1#2
  {
    \int_set:Nn \l__fantasycal_base_month_at_half_year_int { #1 / 2 }
    \int_set:Nn \l__fantasycal_base_nr_days_of_half_year_int
      { \seq_item:Nn #2 { \l__fantasycal_base_month_at_half_year_int } }
  }



%% Definition of weekdays


\NewDocumentCommand \FantasyCalendarAddDays { m }
  {
    \__fantasycal_base_add_list_of_days:n {#1}
  }

\cs_new:Npn \__fantasycal_base_add_list_of_days:n #1
  {
    \seq_set_from_clist:Nn \l__fantasycal_base_day_names_seq {#1}
    \int_set:Nn \l__fantasycal_base_nr_days_per_week_int 
      { \seq_count:N \l__fantasycal_base_day_names_seq }
    \__fantasycal_base_create_pgf_keys:NN 
      \l__fantasycal_base_day_names_seq
      \l__fantasycal_base_nr_days_per_week_int
  }



\cs_new:Npn \__fantasycal_base_create_pgf_keys:NN #1#2
  {
    \seq_map_indexed_inline:Nn #1
      {
        \int_set:Nn \l_tmpa_int { \int_mod:nn {##1} {#2} }
        \__fantasycal_base_new_pdf_weekday:nV {##2} \l_tmpa_int
      }
    \__fantasycal_base_new_pdf_weekday:nn { end ~ of ~ week } { 0 }
    \__fantasycal_base_new_pdf_weekday:nn { begin ~ of ~ week } { 1 }
  }

\cs_new:Npn \__fantasycal_base_new_pdf_weekday:nn #1#2
  {
    \pgfkeys
      {
        /pgf/#1/.code=
          { 
            \ifnum\l_fantasycal_base_current_weekday_tl=#2\relax
              \bool_set_true:N \l__fantasycal_base_date_match_bool 
            \fi 
          }
      }
  }
\cs_generate_variant:Nn \__fantasycal_base_new_pdf_weekday:nn { VV , nV }






%% \ifdate definition 

\prg_new_conditional:Npnn \__fantasycal_base_if_date:n #1 { TF , T , F }
  {
    \__fantasycal_base_launch_if_date:nTF {#1} 
      { \prg_return_true: } { \prg_return_false: }
  }


\prg_new_conditional:Npnn \__fantasycal_base_launch_if_date:n #1 { TF }
  {
    % When this macro is called, the pgfcalendarifdatexxxx macros must
    % be setup correctly
    %
    % Set match to false
    \bool_set_false:N \l__fantasycal_base_date_match_bool
    \pgfqkeys{/pgf}{#1}%
    \bool_if:NTF \l__fantasycal_base_date_match_bool 
      {  \prg_return_true: } 
      { \prg_return_false: }
  }



\pgfkeys{/pgf/all/.code=\bool_set_true:N \l__fantasycal_base_date_match_bool}

\pgfkeys
  {
    /pgf/day ~ of ~ month/.cd,
    .value ~required,
    .code=
      {
        \ifnum#1=\l_fantasycal_base_current_day_tl\relax
          \bool_set_true:N \l__fantasycal_base_date_match_bool
        \fi
      }
  }
\pgfkeys
  {
    /pgf/start ~ of ~ month/.code=
      {
        \ifnum1=\l_fantasycal_base_current_day_tl\relax
          \bool_set_true:N \l__fantasycal_base_date_match_bool
        \fi
      }
  }

\pgfkeys
  {
    /pgf/end ~ of ~ month/.cd, .default=1, .code=
      {
        \bool_if:NF \l__fantasycal_base_date_match_bool
          {
            \group_begin:
            \int_set:Nn \l__fantasycal_base_tmpa_int { \l_fantasycal_base_current_ordinal_int }
            \int_add:Nn \l__fantasycal_base_tmpa_int { #1-1 }
            \bool_if:NTF \l__fantasycal_activate_leap_year_bool
              {
                \__fantasycal_base_get_year_from_ordinal:Nn
                  \l__fantasycal_base_year_int \l__fantasycal_base_tmpa_int
                \__fantasycal_base_check_if_leap_year:n { \l__fantasycal_base_year_int }
                \__fantasycal_base_setup_current_year:
                \int_set:Nn \l__fantasycal_base_tmpa_int
                  {
                    \l__fantasycal_base_tmpa_int - 
                    \__fantasycal_base_print_days_til_start_of_year:n 
                      { \l__fantasycal_base_year_int }
                  }
                %% I use modulo in the "default" way so I need to make
                %% sure that if the day is equal to the nr_of_days_per_year
                %% the value is set to 0.
                \int_compare:nNnT 
                  { \l__fantasycal_base_tmpa_int } = { \l__fantasycal_base_nr_days_per_year_int }
                  { \int_zero:N \l__fantasycal_base_tmpa_int }
              }{
                \int_set:Nn \l__fantasycal_base_tmpa_int
                  { 
                    \int_mod:nn \l__fantasycal_base_tmpa_int 
                      \l__fantasycal_base_default_nr_days_per_year_int 
                  }
              }
            \seq_map_inline:Nn \l__fantasycal_base_cumulative_number_days_seq
              {
                \int_compare:nNnT 
                  { \l__fantasycal_base_tmpa_int } = {##1}
                  {
                    \bool_set_true:N \l__fantasycal_base_date_match_bool
                    \seq_map_break:
                  }
              } 
            \bool_if:NTF \l__fantasycal_base_date_match_bool
              { \group_end: \bool_set_true:N \l__fantasycal_base_date_match_bool }
              { \group_end: \bool_set_false:N \l__fantasycal_base_date_match_bool }
          }
      }
  }


\pgfkeys
  {
    /pgf/equals/.cd , .value ~ required , .code=
      {
        \__fantasycal_base_special_date_to_ordinal:n {#1}
        \ifnum\l_fantasycal_base_current_ordinal_int=\l__fantasycal_base_tmpa_int\relax
          \bool_set_true:N \l__fantasycal_base_date_match_bool
        \fi
      }
  }

\pgfkeys
  {
    /pgf/at ~ least/.cd, .value ~ required, .code=
      {
        \__fantasycal_base_special_date_to_ordinal:n {#1}
        \ifnum \l_fantasycal_base_current_ordinal_int<\l__fantasycal_base_tmpa_int\relax
        \else
          \bool_set_true:N \l__fantasycal_base_date_match_bool
        \fi
      }
  }
%
\pgfkeys
  {
    /pgf/at ~ most/.cd,.value ~ required,.code=
      {
        \__fantasycal_base_special_date_to_ordinal:n {#1}
        \ifnum\l_fantasycal_base_current_ordinal_int>\l__fantasycal_base_tmpa_int\relax
        \else
          \bool_set_true:N \l__fantasycal_base_date_match_bool
        \fi
      }
  }
%
\pgfkeys
  {
    /pgf/between/.cd,.value ~ required,.code ~ args={ #1 and #2 }
      {
        \__fantasycal_base_special_date_to_ordinal:n {#1}
        \ifnum\l_fantasycal_base_current_ordinal_int<\l__fantasycal_base_tmpa_int\relax
        \else
          \__fantasycal_base_special_date_to_ordinal:n {#2}
          \ifnum\l_fantasycal_base_current_ordinal_int>\l__fantasycal_base_tmpa_int\relax
          \else
            \bool_set_true:N \l__fantasycal_base_date_match_bool
          \fi
        \fi
      }
  }

\cs_new:Npn \__fantasycal_base_special_date_to_ordinal:n #1
  {
    \tl_set:Nx \l_tmpa_tl {#1}
    \exp_after:wN \__fantasycal_base_special_split_test:wwwN
      \l_tmpa_tl - \relax {#1}
  }
\cs_new:Npn \__fantasycal_base_special_split_test:wwwN #1-#2-#3\relax#4
  {
    \tl_set:Nx \l_tmpa_tl {#3}
    \tl_if_empty:NTF \l_tmpa_tl
      { \tl_set:Nn \l_tmpa_tl { \l_fantasycal_base_current_year_tl - #1-#2 } }
      { \tl_set:Nn \l_tmpa_tl {#4} }
    \__fantasycal_base_iso_to_ordinal:nN {\l_tmpa_tl} \l__fantasycal_base_tmpa_int
  }



\cs_new:Npn \__fantasycal_base_suggested_name: 
  {
    \tl_if_empty:NF \l__fantasycal_base_calendar_prefix_tl
      { 
        \l__fantasycal_base_calendar_prefix_tl
        - \l_fantasycal_base_current_year_tl
        - \l_fantasycal_base_current_month_tl
        - \l_fantasycal_base_current_day_tl
      }
  }




\cs_new:Npn \__fantasycal_base_print_days_til_start_of_year:n #1
  {
    (
    #1*\l__fantasycal_base_default_nr_days_per_year_int
    \bool_if:NT \l__fantasycal_activate_leap_year_bool
      { + \__fantasycal_base_check_add_leap_year_days:n { #1 - 1 } }
    )
  }
\cs_new:Npn \__fantasycal_base_print_days_of_month:n #1
  { \seq_item:Nn \l__fantasycal_base_number_days_of_months_seq {#1} }
\cs_new:Npn \__fantasycal_base_print_cumulative_days:n #1
  {
    \int_compare:nNnTF {#1} = { 0 }
      { 0 }
      { \seq_item:Nn \l__fantasycal_base_cumulative_number_days_seq {#1} }
  }
\cs_new:Npn \__fantasycal_base_print_day_name:n #1
  {
    \int_compare:nNnTF {#1} = { 0 }
      { 
        \seq_item:Nn \l__fantasycal_base_day_names_seq 
          { \l__fantasycal_base_nr_days_per_week_int } 
      }
      { \seq_item:Nn \l__fantasycal_base_day_names_seq {#1} }
  }
\cs_new:Npn \__fantasycal_base_print_month_name:n #1
  { \seq_item:Nn \l__fantasycal_base_month_names_seq {#1} }













\cs_new:Npn \__fantasycal_base_iso_to_ordinal:nN #1#2
  {
    \group_begin:
    \tl_set:Nx \l__fantasycal_base_tmpa_tl {#1}
    \exp_after:wN
    \__fantasycal_base_split_iso:wwwww \l__fantasycal_base_tmpa_tl +/ {#2}
  }
\cs_new:Npn \__fantasycal_base_split_iso:wwwww #1-#2-#3+#4/#5 
  {
    \int_set:Nn \l__fantasycal_base_year_int {#1}

    \bool_if:NT \l__fantasycal_activate_leap_year_bool
      { 
        \__fantasycal_base_check_if_leap_year:n { \l__fantasycal_base_year_int }
        \__fantasycal_base_setup_current_year: 
      }

    \tl_set:Nx \l__fantasycal_base_tmpb_tl {#2}
    \str_if_eq:VnTF \l__fantasycal_base_tmpb_tl { last }
      {
        \int_set:Nn \l__fantasycal_base_month_int 
          \l__fantasycal_base_nr_months_per_year_int
      }{
        \int_set:Nn \l__fantasycal_base_month_int {#2}
      }
    
    \tl_set:Nx \l__fantasycal_base_tmpb_tl {#3}
    \str_if_eq:VnTF \l__fantasycal_base_tmpb_tl { last }
      { 
        \int_set:Nn \l__fantasycal_base_day_int
           { \__fantasycal_base_print_days_of_month:n { \l__fantasycal_base_month_int }}  
      }
      { \int_set:Nn \l__fantasycal_base_day_int {#3} }


    %% offset
    \tl_set:Nx \l__fantasycal_base_tmpb_tl {#4}
    \tl_if_empty:NTF \l__fantasycal_base_tmpb_tl
      { \int_zero:N \l__fantasycal_base_tmpa_int }
      { \int_set:Nn \l__fantasycal_base_tmpa_int { \l__fantasycal_base_tmpb_tl 0 } }
    
    \int_set:Nn \l__fantasycal_base_tmpb_int
      {
        \__fantasycal_base_print_days_til_start_of_year:n { \l__fantasycal_base_year_int }
         + \__fantasycal_base_print_cumulative_days:n { \l__fantasycal_base_month_int }
         + \l__fantasycal_base_day_int
         + \l__fantasycal_base_tmpa_int
      }
      
    \int_gset_eq:NN \g__fantasycal_base_tmpa_int \l__fantasycal_base_tmpb_int
    \group_end:
    \int_set_eq:NN #5 \g__fantasycal_base_tmpa_int
  }



\cs_new:Npn \__fantasycal_base_check_and_setup_leap_year:nN #1 #2
  {
    \int_set:Nn \l_tmpa_int {#1}
    \bool_if:NTF \l__fantasycal_activate_leap_year_bool
      {
        \__fantasycal_base_get_year_from_ordinal:Nn 
          \l__fantasycal_base_year_int \l_tmpa_int
        \__fantasycal_base_check_if_leap_year:n { \l__fantasycal_base_year_int }
        \__fantasycal_base_setup_current_year: 
      }{
        \int_set:Nn \l__fantasycal_base_year_int 
          { \int_div_truncate:nn \l_tmpa_int \l__fantasycal_base_default_nr_days_per_year_int }
      }
    \tl_set:NV #2 \l__fantasycal_base_year_int 
  }

\cs_new:Npn \__fantasycal_base_ordinal_to_date_shorter:nNNN #1#2#3#4
  {
    %% shorter version, as year is already given and leap year is setup.
    \group_begin:
    \int_set:Nn \l_tmpa_int {#1}
    %% year
    \int_set:Nn \l__fantasycal_base_year_int {#2}
    %% days
    \int_set_eq:NN \l__fantasycal_base_day_int \l_tmpa_int
    \int_set:Nn \l_tmpb_int
      { \__fantasycal_base_print_days_til_start_of_year:n \l__fantasycal_base_year_int }
    % get number of days we are into in current year
    \int_sub:Nn \l__fantasycal_base_day_int { \l_tmpb_int }

    % if zero: we were at end of last year. Set stuff accordingly
    \int_compare:nNnTF { \l__fantasycal_base_day_int } = { 0 }
      {
        \int_decr:N \l__fantasycal_base_year_int
        \int_set_eq:NN \l__fantasycal_base_month_int 
          \l__fantasycal_base_nr_months_per_year_int
        \seq_get_right:NN \l__fantasycal_base_number_days_of_months_seq \l_tmpa_tl
        \int_set:Nn \l__fantasycal_base_day_int { \l_tmpa_tl }
      }{
        % else: get month and day the hard way
        \__fantasycal_base_ordinal_to_date_get_month:N \l__fantasycal_base_day_int
      }
    
    \int_gset_eq:NN \g__fantasycal_base_tmpa_int \l__fantasycal_base_year_int
    \int_gset_eq:NN \g__fantasycal_base_tmpb_int \l__fantasycal_base_month_int
    \int_gset_eq:NN \g__fantasycal_base_tmpc_int \l__fantasycal_base_day_int
    
    \group_end:
    %% Make numbers into tl's
    \tl_set:NV #2 \g__fantasycal_base_tmpa_int
    \tl_set:NV #3 \g__fantasycal_base_tmpb_int
    \tl_set:NV #4 \g__fantasycal_base_tmpc_int
  }



\cs_new:Npn \__fantasycal_base_ordinal_to_date:nNNN #1#2#3#4
  {
    \group_begin:
      \__fantasycal_base_check_and_setup_leap_year:nN {#1} #2
      \__fantasycal_base_ordinal_to_date_shorter:nNNN #1#2#3#4
      \int_gset:Nn \g__fantasycal_base_tmpa_int #2
      \int_gset:Nn \g__fantasycal_base_tmpb_int #3
      \int_gset:Nn \g__fantasycal_base_tmpc_int #4
    \group_end:
    \tl_set:NV #2 \g__fantasycal_base_tmpa_int
    \tl_set:NV #3 \g__fantasycal_base_tmpb_int
    \tl_set:NV #4 \g__fantasycal_base_tmpc_int
  }

\cs_new:Npn \__fantasycal_base_ordinal_to_date_get_month:N #1
  {
    \int_compare:nNnTF {#1} < { \l__fantasycal_base_nr_days_of_half_year_int }
      { \__fantasycal_base_ordinal_to_date_get_month_aux_i: }
      { \__fantasycal_base_ordinal_to_date_get_month_aux_ii: }
  }
  

\cs_new:Npn \__fantasycal_base_ordinal_to_date_get_month_aux_i:
  {
    \int_zero:N \l__fantasycal_base_month_int
    \int_zero:N \l_tmpa_int
    \seq_map_inline:Nn \l__fantasycal_base_cumulative_number_days_seq
      {
        \if_int_compare:w ##1 < \l__fantasycal_base_day_int\relax %>
            \int_incr:N \l__fantasycal_base_month_int 
            \int_set:Nn \l_tmpa_int {##1}
        \else:
            \int_sub:Nn \l__fantasycal_base_day_int { \l_tmpa_int }
            \exp_after:wN \seq_map_break:
        \fi:
      }
  }
\cs_new:Npn \__fantasycal_base_ordinal_to_date_get_month_aux_ii:
  {
    \int_set_eq:NN \l__fantasycal_base_month_int \l__fantasycal_base_nr_months_per_year_int
    \seq_map_inline:Nn \l__fantasycal_base_cumulative_number_days_invers_seq
      {
        \if_int_compare:w ##1 < \l__fantasycal_base_day_int\relax
            \int_sub:Nn \l__fantasycal_base_day_int {##1}
            \exp_after:wN \seq_map_break:
        \else:
            \int_decr:N \l__fantasycal_base_month_int
        \fi:
      }
  }



\cs_new:Npn \__fantasycal_base_ordinal_to_weekday:nN #1#2
  {
    \group_begin:
    \int_set:Nn \l_tmpa_int {#1}
    %% Add zero day shift
    \int_add:Nn \l_tmpa_int { \l__fantasycal_base_zero_day_shift_int }
    \int_gset:Nn \g__fantasycal_base_tmpa_int 
      { \int_mod:nn \l_tmpa_int \l__fantasycal_base_nr_days_per_week_int }
    \group_end:
    \int_set_eq:NN #2 \g__fantasycal_base_tmpa_int
}








%\cs_new:Npn \__fantasycal_base_get_end_day_of_last_month:Nnn #1#2#3
%  {
%    \int_set:Nn #1
%      {
%        \l__fantasycal_base_zero_day_shift_int 
%         + \__fantasycal_base_print_cumulative_days:n {#3}
%         + \l__fantasycal_base_default_nr_days_per_year_int * (#2)
%      }
%    \int_set:Nn #1
%      { \int_mod:nn {#1} { \l__fantasycal_base_nr_days_per_week_int } }
%  }
%


\cs_new:Npn \l__fantasycal_base_print_number_to_minimum_digits:nn #1#2
  {
    \l__fantasycal_base_print_number_to_minimum_digits_base:nnn {#1} {#2} { 0 }
  }
\cs_new:Npn \l__fantasycal_base_print_number_to_minimum_digits_space:nn #1#2
  {
    \l__fantasycal_base_print_number_to_minimum_digits_base:nnn 
      {#1} {#2} { \phantom { 0 } }
  }

\cs_new:Npn \l__fantasycal_base_print_number_to_minimum_digits_base:nnn #1#2#3
  {
    \l__fantasycal_base_print_number_to_minimum_digits_base_aux:ffn
      { \int_eval:n {#1} } { \int_eval:n { #2-1 } } {#3}
  }
\cs_new:Npn  \l__fantasycal_base_print_number_to_minimum_digits_base_aux:nnn #1#2#3
  {
    %% number of digits needs to be at least 1
    \int_compare:nNnTF {#2} > { \c_zero_int }
      {
        %% Check if #1 is smaller than ..., 1000, 100, 10.
        \int_compare:nNnTF {#1} < { 1 \prg_replicate:nn {#2} { 0 } }
          {
            %% True: Add #3 and repeat with #2-1
            #3
            \l__fantasycal_base_print_number_to_minimum_digits_base_aux:nfn 
              {#1} { \int_eval:n { #2-1 } } {#3}
          }
          {#1}
      }
      {#1}
%  
%  
%  
%  
%    \int_compare:nNnTF {#1} < { 1 \prg_replicate:nn {#2} { 0 } }
%      {
%        #3
%        \int_compare:nNnTF {#2} < { 2 }
%          {#1}
%          {
%            \l__fantasycal_base_print_number_to_minimum_digits_base_aux:nfn 
%              {#1} { \int_eval:n { #2-1 } } {#3}
%          }
%      }
%      {#1}
  }
\cs_generate_variant:Nn \l__fantasycal_base_print_number_to_minimum_digits_base_aux:nnn 
  { nf , ff }

% Macro for easy typesetting of days, etc.
%
% #1 = kind selection
% #2 = length and representation selection
%
% Description:
%
% Replaces the shorthand according to the following rules: The
% first letter of the shorthand describes the kind of
% shorthand. Possible kinds are:
%
% d = day of current date (in an invocation of \pgfcalendar)
% m = month of current date
% y = year of current date
% w = week day of current date
%
% The second parameter determines how the kind is represented:
%
% - = shortest possible numerical way (allowed only for d, m, y)
% = = same, but always of the same length (padded with blanks as
%     needed, allowed only for d, m, y)
% 0 = numerical representation for d and m padded with leading zeros.
% t = textual representation (allowed only for d, m, w)
% . = abbreviated textual representation (allowed only for d, m, w)
%
% It is advised that you say, for example,
% \let\%=\pgfcalendarshorthand.
%
% With this setting, you can typeset an ISO-date by saying \%y0-\%m0-\%d0.
% For another example, on 2007-02-09, which is a
% Friday, you can write "\%wt, \%mt \%d-, \%y0" to get "Friday, February 9, 2007"


\cs_new:Npn \__fantsycalendar_shorthand:nn #1#2 
  { 
    \cs_if_exist_use:cF { __fantasycal@shorthand@#1#2 } 
      { \tl_show:n {#1#2:~Nope! } }
  }

\cs_new:cpn { __fantasycal@shorthand@d-} 
  {
    { 
      \int_set:Nn \l_tmpa_int \l_fantasycal_base_current_day_tl
      \int_use:N \l_tmpa_int 
    }
  }
\cs_new:cpn { __fantasycal@shorthand@d= } 
  {
    {
      \int_set:Nn \l_tmpa_int \l_fantasycal_base_current_day_tl
      \ifnum\l_tmpa_int<10\relax
        \setbox0=\hbox{1}\kern\wd0\relax
      \fi
      \int_use:N \l_tmpa_int
    }
  }

\cs_new:cpn { __fantasycal@shorthand@d0} { \l_fantasycal_base_current_day_tl }
\cs_new:cpn { __fantasycal@shorthand@m- } 
  {
    {
      \int_set:Nn \l_tmpa_int \l_fantasycal_base_current_month_tl
      \int_use:N \l_tmpa_int
    }
  }
\cs_new:cpn { __fantasycal@shorthand@m= } 
  {
    {
      \int_set:Nn \l_tmpa_int \l_fantasycal_base_current_month_tl
      \ifnum\l_tmpa_int<10\relax
        \setbox0=\hbox{1}\kern\wd0\relax
      \fi
      \int_use:N \l_tmpa_int
    }
  }

\cs_new:cpn { __fantasycal@shorthand@m0 } {\l_fantasycal_base_current_month_tl }
\cs_new:cpn { __fantasycal@shorthand@y-} { \l_fantasycal_base_current_year_tl }
\cs_new:cpn { __fantasycal@shorthand@y=}{ \l_fantasycal_base_current_year_tl }
\cs_new:cpn { __fantasycal@shorthand@y0 }{ \l_fantasycal_base_current_year_tl }
\cs_new:cpn { __fantasycal@shorthand@w.}  
  { 
    \__fantasycal_base_print_day_name:n { \l_fantasycal_base_current_day_tl } 
  }
\cs_new:cpn { __fantasycal@shorthand@wt } 
  { 
    \__fantasycal_base_print_day_name:n { \l_fantasycal_base_current_day_tl } 
  }
\cs_new:cpn { __fantasycal@shorthand@m.}
  {
    \__fantasycal_base_print_month_name:n { \l_fantasycal_base_current_month_tl }
  }
\cs_new:cpn { __fantasycal@shorthand@mt }
  {
    \__fantasycal_base_print_month_name:n { \l_fantasycal_base_current_month_tl }
  }


% My own:  \%md, \%yd "<month>-<day>", "<year>-<month>-<day>"
%

\cs_new:cpn { __fantasycal@shorthand@md}
  {
    \l_fantasycal_base_current_month_tl - \l_fantasycal_base_current_day_tl
  }
\cs_new:cpn { __fantasycal@shorthand@yd}
  {
    \l_fantasycal_base_current_year_tl -
    \l_fantasycal_base_current_month_tl - \l_fantasycal_base_current_day_tl
  }

%% ordinal
\cs_new:cpn { __fantasycal@shorthand@o0 }
  {
    \int_use:N \l_fantasycal_base_current_ordinal_int
  }
\cs_new:cpn { __fantasycal@shorthand@s0 }
  {
    \int_eval:n 
      {(
        \l_fantasycal_base_current_ordinal_int
        - \__fantasycal_base_print_days_til_start_of_year:n { \l_fantasycal_base_current_year_tl }
      )}
  }


  
  
%
%
%
%
%
%
%
%
%
%
%
%
%
%
% Leap year.
% Leap years are annoyingly difficult to implement

\bool_new:N \l__fantasycal_base_leap_year_bool

\tl_new:N \l__fantasycal_base_leap_storage_aux_tl
\fp_new:N \l__fantasycal_base_leap_year_fraction_fp
\fp_new:N \l__fantasycal_base_leap_year_days_per_year_mean_fp

\int_new:N \l__fantasycal_base_leap_nr_days_added_int
\int_new:N \l__fantasycal_base_nr_days_in_leap_year_int
\prop_new:N \l__fantasycal_base_leap_year_storage_prop

\seq_new:N \l__fantasycal_base_leap_year_days_per_months_seq
\seq_new:N \l__fantasycal_base_leap_year_cumulative_days_seq
\seq_new:N \l__fantasycal_base_leap_year_inverse_cumulative_days_seq



\bool_new:N \l__fantasycal_activate_leap_year_bool
\bool_set_false:N \l__fantasycal_activate_leap_year_bool 


\NewDocumentCommand \DefineLeapYear { +m m }
  {
    \bool_set_true:N \l__fantasycal_activate_leap_year_bool
    \fp_zero:N \l__fantasycal_base_leap_year_fraction_fp
    \__fantasycal_base_if_leap_condition:nT {#1} {#2}
  }

\cs_new:Npn \__fantasycal_base_if_leap_condition:nT #1#2
  {
    \__fantasycal_base_leap_year_setup:
    \__fantasycal_base_leap_year_additions:n {#2}
%
    \__fantasycal_base_lp_start:ww
      #1 \q_recursion_tail \q_recursion_stop
%      
    \fp_set:Nn \l__fantasycal_base_leap_year_fraction_fp 
      { \l__fantasycal_base_leap_year_fraction_fp*\l__fantasycal_base_leap_nr_days_added_int }
    \fp_set:Nn \l__fantasycal_base_leap_year_days_per_year_mean_fp
      { 
        \l__fantasycal_base_leap_year_fraction_fp + 
        \l__fantasycal_base_default_nr_days_per_year_int 
      }
    \int_compare:nNnF
      \l__fantasycal_base_nr_days_in_leap_year_int
      =
      {
        \l__fantasycal_base_default_nr_days_per_year_int +
        \l__fantasycal_base_leap_nr_days_added_int
      }
      {
        \tl_show:n {ERROR!\ number \ days\ per \ year \ wrong\ in \ leap \ year! }
      }
  }

\cs_new:Npn \__fantasycal_base_leap_year_setup:
  {
    \int_zero:N \l__fantasycal_base_leap_nr_days_added_int
    \seq_clear:N \l__fantasycal_base_leap_year_days_per_months_seq
    \seq_clear:N \l__fantasycal_base_leap_year_cumulative_days_seq
    \seq_clear:N \l__fantasycal_base_leap_year_inverse_cumulative_days_seq
    \cs_set:Npn \__fantasycal_base_check_add_leap_year_days_aux:n ##1 { }
    \cs_set:Npn \__fantasycal_base_check_if_leap_year_aux:n ##1 { }
  }


\cs_new:Npn \__fantasycal_base_leap_year_additions:n #1
  {
    \int_zero:N \l__fantasycal_base_tmpa_int
    \int_zero:N \l__fantasycal_base_nr_days_in_leap_year_int
%    
    \prop_set_from_keyval:Nn \l__fantasycal_base_leap_year_storage_prop {#1}
%    
    \seq_set_eq:NN \l_tmpa_seq \l__fantasycal_base_default_number_days_of_months_seq
    \seq_map_indexed_inline:Nn \l__fantasycal_base_month_names_seq
       {
         \seq_pop_left:NN \l_tmpa_seq \l_tmpa_tl
         \int_set:Nn \l__fantasycal_base_tmpa_int { \l_tmpa_tl }
         \prop_get:NnNT \l__fantasycal_base_leap_year_storage_prop {##2} \l_tmpb_tl
           { 
             \int_add:Nn \l__fantasycal_base_leap_nr_days_added_int { \l_tmpb_tl }
             \int_add:Nn \l__fantasycal_base_tmpa_int { \l_tmpb_tl }
           }
         \seq_put_right:NV \l__fantasycal_base_leap_year_days_per_months_seq 
           \l__fantasycal_base_tmpa_int
         \seq_put_right:NV \l__fantasycal_base_leap_year_cumulative_days_seq 
           \l__fantasycal_base_nr_days_in_leap_year_int
         \seq_put_left:NV \l__fantasycal_base_leap_year_inverse_cumulative_days_seq 
           \l__fantasycal_base_nr_days_in_leap_year_int
         \int_add:Nn \l__fantasycal_base_nr_days_in_leap_year_int 
           \l__fantasycal_base_tmpa_int
       }
%       
  }

\cs_new:Npn \__fantasycal_base_lp_start:ww #1 year ~ #2 divisible ~ by ~ #3;
  {
    \int_set:Nn \l_tmpa_int {#3}
    \__fantasycal_base_lp_store:nV {#2} \l_tmpa_int
    \peek_meaning_ignore_spaces:NTF b
      { \__fantasycal_base_lp_contin:ww }
      { \use_none_delimit_by_q_recursion_stop:w }
  }
\cs_new:Npn \__fantasycal_base_lp_contin:ww #1 but ~ #2 divisible ~ by ~ #3;
  {
    \int_set:Nn \l_tmpa_int {#3}
    \__fantasycal_base_lp_store:nV {#2} \l_tmpa_int
    \peek_meaning_ignore_spaces:NTF b
      { \__fantasycal_base_lp_contin:ww }
      { \use_none_delimit_by_q_recursion_stop:w }
  }

\cs_new:Npn \__fantasycal_base_lp_store:nn #1#2
  {
    \str_if_eq:nnTF { not~ } {#1}
      { 
        \__fantasycal_base_lp_store_values:nnNV
          {#2} { - } \bool_set_false:N \l__fantasycal_base_leap_nr_days_added_int
      }{ 
        \__fantasycal_base_lp_store_values:nnNV
          {#2} { + } \bool_set_true:N \l__fantasycal_base_leap_nr_days_added_int
      }
  }
\cs_generate_variant:Nn \__fantasycal_base_lp_store:nn { nV }

\cs_new:Npn \__fantasycal_base_lp_store_values:nnNn #1#2#3#4
  {
    % #2: + or - sign.
    \fp_add:Nn \l__fantasycal_base_leap_year_fraction_fp { #2 1/#1 }
    \__fantasycal_base_add_to_checking:n
      {
        \int_compare:nNnT
          { \int_mod:nn {##1} {#1} } = { 0 }
          { #3 \l__fantasycal_base_leap_year_bool }
      }
    \__fantasycal_base_check_add_leap_year_days_put_right:n
      { #2 \int_div_truncate:nn {##1} {#1}*#4 }
  }
\cs_generate_variant:Nn \__fantasycal_base_lp_store_values:nnNn { nnNV }



\cs_generate_variant:Nn \cs_set:Npn { Npo }

\cs_new:Npn \__fantasycal_base_check_if_leap_year:n #1
  {
    \bool_set_false:N \l__fantasycal_base_leap_year_bool
    \int_compare:nNnF {#1} = { 0 }
      { \__fantasycal_base_check_if_leap_year_aux:f { \int_eval:n {#1} } }
  }
\cs_new:Npn \__fantasycal_base_add_to_checking:n #1 
  { 
    \cs_set:Npo \__fantasycal_base_check_if_leap_year_aux:n ##1
      {
        \__fantasycal_base_check_if_leap_year_aux:n {##1}
        #1
      }
  }
\cs_new:Npn \__fantasycal_base_check_if_leap_year_aux:n #1 { }
\cs_generate_variant:Nn \__fantasycal_base_check_if_leap_year_aux:n { f }
%  
\cs_new:Npn \__fantasycal_base_check_add_leap_year_days:n #1 
  { 
    %% DO NOT CHECK THE BOOL HERE!
    \__fantasycal_base_check_add_leap_year_days_aux:f { \int_abs:n {#1} } 
  }
\cs_new:Npn \__fantasycal_base_check_add_leap_year_days_put_right:n #1 
  { 
    \cs_set:Npo \__fantasycal_base_check_add_leap_year_days_aux:n ##1
      {
        \__fantasycal_base_check_add_leap_year_days_aux:n {##1}
        #1
      }
  }
\cs_new:Npn \__fantasycal_base_check_add_leap_year_days_aux:n #1 { }
\cs_generate_variant:Nn \__fantasycal_base_check_add_leap_year_days_aux:n { f }

\int_new:N \l__fantasycal_base_test_year_int
\int_new:N \l__fantasycal_base_test_ordinal_int
\bool_new:N \l__fantasycal_base_test_year_loop_bool

\cs_new:Npn \__fantasycal_base_get_year_from_ordinal:Nn #1#2
  {
    \group_begin:
    %% Start getting an approximate year
    \int_set:Nn \l__fantasycal_base_test_year_int 
      { \int_div_truncate:nn {#2} { \l__fantasycal_base_default_nr_days_per_year_int } }

    %% Now start the loop until we get the year right. 
    \bool_set_false:N \l__fantasycal_base_test_year_loop_bool
    \bool_do_until:Nn \l__fantasycal_base_test_year_loop_bool
      {
        %% Check leap year conditions
        \__fantasycal_base_check_if_leap_year:n { \l__fantasycal_base_test_year_int }
        %% calculate current ordinal
        \int_set:Nn \l__fantasycal_base_test_ordinal_int
          { 
            %% Add 1 in order to make sure the last day of the year is
            %% still included
            1 +
            \__fantasycal_base_print_days_til_start_of_year:n \l__fantasycal_base_test_year_int
          }
        \int_set:Nn \l__fantasycal_base_test_ordinal_int
          { #2 - \l__fantasycal_base_test_ordinal_int }
        \int_compare:nNnTF { \l__fantasycal_base_test_ordinal_int } < { 0 }
          { \int_decr:N \l__fantasycal_base_test_year_int }
          {
            %% test_ordinal is positive!
            \__fantasycal_base_get_nr_of_days_this_year:N 
              \l__fantasycal_base_nr_days_per_year_int
            
            % are we within this year or beyond?
            \int_compare:nNnTF
              \l__fantasycal_base_test_ordinal_int >
              \l__fantasycal_base_nr_days_per_year_int
              { \int_incr:N \l__fantasycal_base_test_year_int }
              { 
                %% Found it!
                \bool_set_true:N \l__fantasycal_base_test_year_loop_bool 
              }
          }
      }
    \exp_args:NNNV
    \group_end:
    \int_set:Nn #1 \l__fantasycal_base_test_year_int
  }

\cs_new:Npn \__fantasycal_base_get_nr_of_days_this_year:N #1
  {
    \bool_if:NTF \l__fantasycal_base_leap_year_bool
      { \int_set_eq:NN #1 \l__fantasycal_base_nr_days_in_leap_year_int }
      { \int_set_eq:NN #1 \l__fantasycal_base_default_nr_days_per_year_int }
  }


\cs_new:Npn \__fantasycal_base_setup_current_year:
  {
    \bool_if:NTF \l__fantasycal_base_leap_year_bool
      {
        \int_set_eq:NN \l__fantasycal_base_nr_days_per_year_int
          \l__fantasycal_base_nr_days_in_leap_year_int
        \seq_set_eq:NN \l__fantasycal_base_number_days_of_months_seq 
          \l__fantasycal_base_leap_year_days_per_months_seq
        \seq_set_eq:NN \l__fantasycal_base_number_days_of_months_seq
          \l__fantasycal_base_leap_year_days_per_months_seq
        \seq_set_eq:NN \l__fantasycal_base_cumulative_number_days_seq
          \l__fantasycal_base_leap_year_cumulative_days_seq
        \seq_set_eq:NN \l__fantasycal_base_cumulative_number_days_invers_seq
          \l__fantasycal_base_leap_year_inverse_cumulative_days_seq
      }{
        \seq_set_eq:NN \l__fantasycal_base_number_days_of_months_seq 
          \l__fantasycal_base_default_number_days_of_months_seq
        \seq_set_eq:NN \l__fantasycal_base_cumulative_number_days_seq
          \l__fantasycal_base_default_cumulative_number_days_seq
        \seq_set_eq:NN \l__fantasycal_base_cumulative_number_days_invers_seq
          \l__fantasycal_base_default_cumulative_number_days_invers_seq
        \int_set_eq:NN \l__fantasycal_base_nr_days_per_year_int
          \l__fantasycal_base_default_nr_days_per_year_int
      }
  }



















\cs_set_eq:NN \bfcalisotoordinal \__fantasycal_base_iso_to_ordinal:nN
\cs_set_eq:NN \bfcalordinaltodate \__fantasycal_base_ordinal_to_date:nNNN
\cs_set_eq:NN \bfcalprintdaystilstartofyear 
  \__fantasycal_base_print_days_til_start_of_year:n
\cs_set_eq:NN \bfcalordinaltoweekday \__fantasycal_base_ordinal_to_weekday:nN

\cs_set_eq:NN \bfcalnumbertominimumdigits \l__fantasycal_base_print_number_to_minimum_digits:nn


\ExplSyntaxOff
\makeatother

\endinput
