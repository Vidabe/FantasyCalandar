% Based on "tikzlibrarycalendar.code.tex"  by Till Tantau


\ifcsname fantasycalendar.code.tex.loaded\endcsname
  \endinput
\fi
\expandafter\def\csname fantasycalendar.code.tex.loaded\endcsname{}


\makeatletter
\@ifpackageloaded{tikz}{}
  { \RequirePackage{tikz} }
\@ifpackageloaded{ragged2e}{}
  {\RequirePackage{ragged2e}}
\makeatother
%\input fantasycalenderbase.code.tex
\input fantasycalendermoon.code.tex

\usetikzlibrary{positioning}

\makeatletter
\ExplSyntaxOn

%: Variables

\tl_new:N \g__fantasycal_tmpa_tl
\tl_new:N \l__fantasycal_tmpa_tl

\int_new:N \l__fantasycal_tmpa_int
\int_new:N \l__fantasycal_tmpb_int

\dim_new:N \l__fantasycal_tmpa_dim
\dim_new:N \l__fantasycal_tmpb_dim

\fp_new:N \l__fantasycal_tmpa_fp

\seq_new:N \l__fantasycal_tmpa_seq

% -------

\tl_new:N \l__fantasycal_dates_start_tl 
\tl_new:N \l__fantasycal_dates_end_tl 

\tl_new:N \l__fantasycal_at_begin_day_tl 
\tl_new:N \l__fantasycal_at_end_day_tl 
\tl_new:N \l__fantasycal_before_day_tl 
\tl_new:N \l__fantasycal_after_day_tl 

\tl_new:N \l__fantasycal_draw_day_xshift_tl 
\tl_new:N \l__fantasycal_draw_day_yshift_tl 
\tl_new:N \l__fantasycal_draw_month_xshift_tl 
\tl_new:N \l__fantasycal_draw_month_yshift_tl 

\tl_new:N \l__fantasycal_text_box_tl
\tl_new:N \fantasycalTextDay
\tl_new:N \l__fantasycal_text_day_tl
\tl_new:N \l__fantasycal_text_week_day_tl
\tl_new:N \l__fantasycal_text_month_tl
\tl_new:N \l__fantasycal_text_year_tl
\tl_new:N \l__fantasycal_code_box_tl
\tl_new:N \l__fantasycal_code_day_tl
\tl_new:N \l__fantasycal_code_week_day_tl
\tl_new:N \l__fantasycal_code_month_tl
\tl_new:N \l__fantasycal_code_year_tl

\tl_new:N \l__fantasycal_draw_width_tl

\bool_new:N \l__fantasycal_tmpa_bool

\cs_new:Npn \__fantasycal_sanitize_weekday_for_tikz:N #1
  {
    \int_set:Nn #1 { \l_fantasycal_base_current_weekday_tl }
    \int_compare:nNnT {#1} = 0
      { \int_set_eq:NN #1 \l__fantasycal_base_nr_days_per_week_int }
  }



\tikzset{ dates/.code={ \__fantasycal_dates_parse:ww #1 \q_no_value } }
\cs_new:Npn \__fantasycal_dates_parse:ww #1 to #2 \q_no_value
  {
    \tl_set:Nx \l__fantasycal_dates_start_tl {#1}
    \tl_set:Nx \l__fantasycal_dates_end_tl {#2}
  }

\tikzset
  { 
    %% year-month
    month/.code= { \tikzset{ dates={ #1-1 to #1-last } } } ,
    months/.code= { \__fantasycal_months_parse:ww #1 \q_no_value }
  }
\cs_new:Npn \__fantasycal_months_parse:ww #1 to #2 \q_no_value
  {
    \tikzset{ dates={ #1-1 to #2-last } }
  }
\tikzset
  { 
    %% year
    year/.code= { \tikzset{ dates={ #1-1-1 to #1-last-last }  } } 
  }


\bool_new:N \l__fantasycal_box_size_given_bool
\tl_new:N \l__fantasycal_calendar_box_width_tl
\tl_new:N \l__fantasycal_calendar_box_height_tl
\dim_new:N \l__fantasycal_box_width_dim
\dim_new:N \l__fantasycal_box_height_dim
\dim_new:N \l__fantasycal_box_inner_x_sep_dim
\dim_new:N \l__fantasycal_box_inner_y_sep_dim
\dim_set:Nn \l__fantasycal_box_inner_x_sep_dim { 2pt }
\dim_set:Nn \l__fantasycal_box_inner_y_sep_dim { 2pt }

\tikzset
  { 
    sep ~ to ~ box/.code= { \dim_set:Nn \l__fantasycal_box_inner_sep_dim {#1} } ,
    box ~ width/.code = 
      { 
        \bool_set_true:N \l__fantasycal_box_size_given_bool
        \tikzset 
          { 
            days = { inner ~ xsep = \l__fantasycal_box_inner_x_sep_dim }  ,
            box = { minimum ~ width=\l__fantasycal_calendar_box_width_tl } ,  
          }
        \tl_put_right:Nn \l__fantasycal_box_size_setup_tl
          {
            \str_if_eq:nnTF {#1} { fit }
              {
                %% Fitting  width is quite easy. -1pt to remove overfull box warnings
                \dim_set:Nn \l__fantasycal_tmpa_dim
                  { \textwidth / \l__fantasycal_base_nr_days_per_week_int - 1pt }
                \tl_set:NV \l__fantasycal_calendar_box_width_tl \l__fantasycal_tmpa_dim
              }{
                \tl_set:Nn \l__fantasycal_calendar_box_width_tl {#1} 
              }
            \tl_set_eq:NN \l__fantasycal_draw_day_xshift_tl 
              \l__fantasycal_calendar_box_width_tl
            \dim_set:Nn \l__fantasycal_box_width_dim 
              { 
                \l__fantasycal_calendar_box_width_tl 
                  - 1\pgflinewidth
                  - 2\l__fantasycal_box_inner_x_sep_dim 
              } 
          }
      } ,
    box ~ height/.code = 
      { 
        \bool_set_true:N \l__fantasycal_box_size_given_bool
        \tikzset 
          { 
            days = { inner ~ ysep=\l__fantasycal_box_inner_y_sep_dim } ,
            box = { minimum ~ height=\l__fantasycal_calendar_box_height_tl } ,
          }
        \tl_put_right:Nn \l__fantasycal_box_size_setup_tl
          {
            \str_if_eq:nnTF {#1} { fit }
              {
                \bool_if:NTF \l__fantasycal_activate_leap_year_bool
                  {
                    \seq_set_eq:NN \l__fantasycal_tmpa_seq 
                      \l__fantasycal_base_leap_year_days_per_months_seq 
                  }{
                    \seq_set_eq:NN \l__fantasycal_tmpa_seq 
                      \l__fantasycal_base_number_days_of_months_seq 
                  }
                %% height is a bit more complicated, sadly.
                %% get days of month with highest number of days
                \int_set:Nn \l__fantasycal_tmpa_int
                  { \fp_eval:n { max ( \seq_use:Nn \l__fantasycal_tmpa_seq { , } ) } }

                %% Calculate the maximum number of rows a month can have. For this, assume
                %% that the month starts at the end of the current week.
                %% \l__fantasycal_tmpa_int is now the number of rows i have.
                \int_add:Nn \l__fantasycal_tmpa_int 
                  { \l__fantasycal_base_nr_days_per_week_int-1 }
                \int_set:Nn \l__fantasycal_tmpa_int
                  { 
                    \fp_eval:n
                      {
                        ceil
                          (
                            \l__fantasycal_tmpa_int /
                            \l__fantasycal_base_nr_days_per_week_int
                          )
                      }
                  }
                
                %% Remove header from the vertival space
                \bool_if:NTF \l__fantasycal_draw_monthname_bool
                  { \dim_set:Nn \l__fantasycal_tmpa_dim { 3.25\baselineskip } }
                  {
                    \bool_if:NTF \l__fantasycal_draw_weekday_bool
                      { \dim_set:Nn \l__fantasycal_tmpa_dim { 2\baselineskip } }
                      { \dim_zero:N \l__fantasycal_tmpa_dim }
                  }
                %% Calculate space available
                \dim_set:Nn \l__fantasycal_tmpa_dim { ( \textheight - \l__fantasycal_tmpa_dim ) / \l__fantasycal_tmpa_int }
                \tl_set:NV \l__fantasycal_calendar_box_height_tl \l__fantasycal_tmpa_dim
              }{
                \tl_set:Nn \l__fantasycal_calendar_box_height_tl {#1} 
              }
            \tl_set_eq:NN \l__fantasycal_draw_day_yshift_tl 
              \l__fantasycal_calendar_box_height_tl
            \dim_set:Nn \l__fantasycal_box_height_dim 
              { 
                \l__fantasycal_calendar_box_height_tl 
                  - 1\pgflinewidth
                  - 3\l__fantasycal_box_inner_y_sep_dim 
              } 
          }
      } ,
    box ~ size/.code = 
      { 
        \bool_set_true:N \l__fantasycal_box_size_given_bool
        \str_if_eq:nnTF { fit-square } {#1}
          {
            %% not quite optimal, but it works
            \tikzset { box ~ height = { fit } , box ~ width = { fit } } 
            \__fantasycal_calculate_box_size:
            %% Check which is lower (width or height) and set the other one to the same value
            \fp_compare:nNnTF 
              \l__fantasycal_calendar_box_width_tl 
              < % >
              \l__fantasycal_calendar_box_height_tl
              { \tikzset { box ~ height = { \l__fantasycal_calendar_box_width_tl } } }
              { \tikzset { box ~ width = { \l__fantasycal_calendar_box_height_tl } } }
          }{
            \tikzset { box ~ height = {#1} , box ~ width = {#1} } 
          }
      } ,
  }


\tl_new:N \l__fantasycal_box_size_setup_tl
\cs_new:Npn \__fantasycal_calculate_box_size:
  {
    \l__fantasycal_box_size_setup_tl
  }


\tikzset
  { 
    execute ~ at ~ begin ~ day ~ scope/.code=
      { \tl_put_right:Nn \l__fantasycal_at_begin_day_tl {#1} }
  }
\tikzset
  { 
    execute ~ at ~ end ~ day ~ scope/.code=
      { \tl_put_left:Nn \l__fantasycal_at_end_day_tl {#1} }
  }
\tikzset
  { 
    execute ~ before ~ day ~ scope/.code=
      { \tl_put_right:Nn \l__fantasycal_before_day_tl {#1} }
  }
\tikzset
  { 
    execute ~ after ~ day ~ scope/.code=
      { \tl_put_right:Nn \l__fantasycal_after_day_tl {#1} }
  }


\tl_set:Nn \l__fantasycal_draw_day_xshift_tl { 3.5ex }
\tl_set:Nn \l__fantasycal_draw_day_yshift_tl { 3ex }

\tikzset
  { 
    day ~ xshift/.code=
      { \tl_set:Nn \l__fantasycal_draw_day_xshift_tl {#1} }
  }
\tikzset
  { 
    day ~ yshift/.code=
      { \tl_set:Nn \l__fantasycal_draw_day_yshift_tl {#1} }
  }

\tl_set:Nn \l__fantasycal_draw_month_xshift_tl {9ex}
\tl_set:Nn \l__fantasycal_draw_month_yshift_tl {9ex}
  
\tikzset
  { 
    month ~ xshift/.code=
      { \tl_set:Nn \l__fantasycal_draw_month_xshift_tl {#1} }
  }
\tikzset
  { 
    month ~ yshift/.code=
      { \tl_set:Nn \l__fantasycal_draw_month_yshift_tl {#1} }
  }


\tl_new:N \l__fantasycal_font_year_tl
\tl_new:N \l__fantasycal_font_month_tl
\tl_new:N \l__fantasycal_font_week_day_tl
\tl_new:N \l__fantasycal_font_day_tl
\tl_new:N \l__fantasycal_font_notes_tl

\tl_set:Nn \l__fantasycal_font_month_tl { \Large\bfseries }

\tl_set:Nn \l__fantasycal_code_day_tl 
  {
    \node
      ( \__fantasycal_base_suggested_name: ) [ every ~ day ]
      { 
        \bool_if:NTF \l__fantasycal_box_size_given_bool 
          {
            \parbox [ c ] [ \l__fantasycal_box_height_dim ] 
              [ \l__fantasycal_vertical_day_tl ]
              { \l__fantasycal_box_width_dim }
              { 
                \l__fantasycal_font_day_tl
                \l__fantasycal_ragged_day_tl
                \fantasycalTextDay
              }
          }{ 
            \l__fantasycal_font_day_tl \fantasycalTextDay 
          }
      } ;
  }
\tl_set:Nn \l__fantasycal_code_box_tl 
  { 
    \bool_if:NT \l__fantasycal_box_size_given_bool
      {
        \node ( \__fantasycal_base_suggested_name: - box ) [ every ~ box ] 
          { \l__fantasycal_text_box_tl } ; 
      }
  }



\tl_set:Nn \l__fantasycal_code_week_day_tl 
  {\node [every ~ weekday] {\l__fantasycal_font_week_day_tl\l__fantasycal_text_week_day_tl };}
\tl_set:Nn \l__fantasycal_code_month_tl 
  { \node [every ~ month] { \l__fantasycal_font_month_tl \l__fantasycal_text_month_tl } ; }
\tl_set:Nn \l__fantasycal_code_year_tl 
  { \node [every ~ year] { \l__fantasycal_font_year_tl\l__fantasycal_text_year_tl } ; }

\tl_new:N \l__fantasycal_text_day_moon_hook_tl
\tl_new:N \l__fantasycal_text_day_note_hook_tl
\tl_new:N \l__fantasycal_text_month_year_hook_left_tl
\tl_new:N \l__fantasycal_text_month_year_hook_right_tl
\tl_new:N \l__fantasycal_text_month_number_hook_tl

\tl_set:Nn \l__fantasycal_text_box_tl { \phantom{1} } %% text in node shifts thing up
\tl_set:Nn \fantasycalTextDay 
  { 
    \l__fantasycal_text_day_tl
    \l__fantasycal_text_day_moon_hook_tl 
    \l__fantasycal_text_day_note_hook_tl
    \l__fantasycal_text_task_tl
  }
\tl_set:Nn \l__fantasycal_text_day_tl { \%d-  }
\tl_set:Nn \l__fantasycal_text_week_day_tl { \%wt }
\tl_set:Nn \l__fantasycal_text_month_tl 
  { 
    \l__fantasycal_text_month_year_hook_left_tl 
    \%mt \l__fantasycal_text_month_number_hook_tl 
    \l__fantasycal_text_month_year_hook_right_tl 
  }
\tl_set:Nn \l__fantasycal_text_year_tl { \%y0 }


\tikzset
  { 
    day ~ code/.code= { \tl_set:Nn \l__fantasycal_code_day_tl {#1} }
  }
\tikzset
  { 
    day ~ text/.code= { \tl_set:Nn \l__fantasycal_text_day_tl {#1} }
  }
\tikzset
  { 
    day ~ font/.code= { \tl_set:Nn \l__fantasycal_font_day_tl {#1} }
  }
\tikzset
  { 
    weekday ~ text/.code= { \tl_set:Nn \l__fantasycal_text_week_day_tl {#1} } ,
    weekday ~ font/.code= { \tl_set:Nn \l__fantasycal_font_week_day_tl {#1} } ,
  }
\tikzset
  { 
    every ~ day/.style= { anchor=base ~ east } 
  }
\tikzset
  { 
    every ~ box/.style={anchor=base ~ east} 
  }
\tikzset
  { 
    days/.code= { \tikzset{every ~ day/.append ~ style={#1} } }
  }
\tikzset
  { 
    box/.code= { \tikzset{every ~ box/.append ~ style={#1} } }
  }


\tikzset
  { 
    month ~ code/.code= { \tl_set:Nn \l__fantasycal_code_month_tl {#1} }
  }
\tikzset
  { 
    month ~ text/.code= { \tl_set:Nn \l__fantasycal_text_month_tl {#1} }
  }
\tikzset
  { 
    month ~ font/.code= { \tl_set:Nn \l__fantasycal_font_month_tl {#1} }
  }
\tikzset
  { 
    month ~ add ~ number/.code= { \tl_set:Nn \l__fantasycal_text_month_number_hook_tl {#1} }
  }
\tikzset{every ~ month/.style={}}


\tikzset
  { 
    year ~ code/.code= { \tl_set:Nn \l__fantasycal_code_year_tl {#1} }
  }
\tikzset
  { 
    year ~ text/.code= { \tl_set:Nn \l__fantasycal_text_year_tl {#1} }
  }
\tikzset
  { 
    year ~ font/.code= { \tl_set:Nn \l__fantasycal_font_year_tl {#1} }
  }
\tikzset{every ~ year/.style={}}

\tikzset
  {
    , add ~ year ~ to ~ month/ .is ~ choice,
    , add ~ year ~ to ~ month/ left /.code = 
      { 
        \tl_clear:N \l__fantasycal_text_month_year_hook_right_tl
        \tl_set:Nn \l__fantasycal_text_month_year_hook_left_tl 
          { \l__fantasycal_text_year_tl \space -- \space}
      }
    , add ~ year ~ to ~ month/right /.code = 
      { 
        \tl_clear:N \l__fantasycal_text_month_year_hook_left_tl
        \tl_set:Nn \l__fantasycal_text_month_year_hook_right_tl 
          { \space -- \space \l__fantasycal_text_year_tl}
      }
    , add ~ year ~ to ~ month/.default = { left }
  }

\tikzset
  { 
    box ~ draw/.code={ \tikzset { box = { draw=#1 } } }  
  }
  
\tl_new:N \l__fantasycal_ragged_day_tl
\tl_set:Nn \l__fantasycal_ragged_day_tl \RaggedRight
\tikzset
  { 
    , box ~ ragged / .is ~ choice  
    , box ~ ragged / left / .code = { \tl_set:Nn \l__fantasycal_ragged_day_tl \RaggedLeft }
    , box ~ ragged / center / .code = { \tl_set:Nn \l__fantasycal_ragged_day_tl   \Centering }
    , box ~ ragged / right / .code = { \tl_set:Nn \l__fantasycal_ragged_day_tl \RaggedRight }
    , box ~ ragged / .default = { right }
  }
  
\tl_new:N \l__fantasycal_vertical_day_tl
\tl_set:Nn \l__fantasycal_vertical_day_tl { t } 
\tikzset
  { 
    , box ~ vertical / .is ~ choice  
    , box ~ vertical / t / .code = { \tl_set:Nn \l__fantasycal_vertical_day_tl t }
    , box ~ vertical / b / .code = { \tl_set:Nn \l__fantasycal_vertical_day_tl   b }
    , box ~ vertical / c / .code = { \tl_set:Nn \l__fantasycal_vertical_day_tl c }
    , box ~ vertical / top / .code = { \tikzset { box ~ vertical = t } }
    , box ~ vertical / bottom / .code = { \tikzset { box ~ vertical = b } }
    , box ~ vertical / center / .code = { \tikzset { box ~ vertical = c } }
  }



\tl_set:Nn \l__fantasycal_draw_width_tl { 10 }
\tikzset
  { 
    l__fantasycal_draw_width_tl/.code= 
      { \tl_set:Nn \l__fantasycal_draw_width_tl {#1} } 
  }

\bool_new:N \l__fantasycal_draw_weekday_bool
\tikzset
  { 
    print-weekdays/.code= 
      { \bool_set_true:N \l__fantasycal_draw_weekday_bool }  ,
  }
\bool_new:N \l__fantasycal_draw_monthname_bool
\tikzset
  { 
    print-monthnames/.code= 
      { \bool_set_true:N \l__fantasycal_draw_monthname_bool }  ,
  }
















%% Week list

\tikzset
  {
    week ~ list/.style = 
      {
        execute ~ before ~ day ~ scope =
          {
            \ifdateT{day ~ of ~ month = 1}
              {
                \ifdateF { equals = \l__fantasycal_dates_start_tl }
                  { 
                    % On first of month, except when first date in calendar.
                    \pgfmathsetlength{\pgf@y}{\l__fantasycal_draw_month_yshift_tl}
                    \pgftransformyshift{-\pgf@y}
                  } 
              }
          }
        ,
        execute ~ at ~ begin ~ day ~ scope =
          {
            \pgfmathsetlength \l__fantasycal_tmpa_dim { \l__fantasycal_draw_day_xshift_tl}
            \__fantasycal_sanitize_weekday_for_tikz:N \l__fantasycal_tmpa_int
            \dim_set:Nn \l__fantasycal_tmpa_dim { \l__fantasycal_tmpa_int \l__fantasycal_tmpa_dim }
            \pgftransformxshift { \l__fantasycal_tmpa_dim }
          }
        ,
        execute ~ after ~ day ~ scope=
          {
            \ifdateT {end ~ of ~ week}
              {
                \pgfmathsetlength{\l__fantasycal_tmpb_dim}{\l__fantasycal_draw_day_yshift_tl}
                \pgftransformyshift{-\l__fantasycal_tmpb_dim}
              }
          }
        ,
        l__fantasycal_draw_width_tl = \l__fantasycal_base_nr_days_per_week_int
      }    
  }
    
    
    

% Month list
%

\tl_new:N \l__fantasycal_month_list_tl

\tikzset
  {
    month ~ list/.style=
      {
        execute ~ before ~ day ~ scope=
          {
            \ifdateT {day ~ of ~ month=1}
              {
                \ifdateF { equals = \l__fantasycal_dates_start_tl }
                  {
                    % On first of month, except when first date in calendar.
                    \pgfmathsetlength{\l__fantasycal_tmpa_dim}{\l__fantasycal_draw_month_yshift_tl}
                    \pgftransformyshift{-\l__fantasycal_tmpa_dim}
                  }
              }
            \ifdateT {day ~ of ~ month=1}
              {
                \__fantasycal_sanitize_weekday_for_tikz:N \l__fantasycal_tmpa_int
                \tl_set:NV \l__fantasycal_month_list_tl \l__fantasycal_tmpa_int
              }  
            \ifdateT {equals=\l__fantasycal_dates_start_tl}
              {
                {
                  \int_set_eq:NN \l__fantasycal_tmpa_int \l_fantasycal_base_current_ordinal_int
                  \int_sub:Nn \l__fantasycal_tmpa_int \l_fantasycal_base_current_day_tl
                  \int_incr:N \l__fantasycal_tmpa_int
                  \__fantasycal_base_ordinal_to_weekday:nN 
                    { \l__fantasycal_tmpa_int } \l__fantasycal_tmpb_int
                  \__fantasycal_sanitize_weekday_for_tikz:N \l__fantasycal_tmpb_int
                  \tl_gset:Nx \g__fantasycal_tmpa_tl { \int_use:N \l__fantasycal_tmpb_int }
                }
                \tl_set_eq:NN \l__fantasycal_month_list_tl \g__fantasycal_tmpa_tl
              }
          }
          ,
        execute ~ at ~ begin ~ day ~ scope=
          {
            \pgfmathsetlength \l__fantasycal_tmpa_dim { \l__fantasycal_draw_day_xshift_tl }
            \int_set:Nn \l__fantasycal_tmpb_dim { \l_fantasycal_base_current_day_tl \l__fantasycal_tmpa_dim }
            \dim_add:Nn \l__fantasycal_tmpb_dim { \l__fantasycal_month_list_tl \l__fantasycal_tmpa_dim }
            \dim_sub:Nn \l__fantasycal_tmpb_dim { \l__fantasycal_tmpa_dim }
            \pgftransformxshift { \l__fantasycal_tmpb_dim }
          }
        ,
        l__fantasycal_draw_width_tl= 
          \fp_eval:n 
          { 
            max ( \seq_use:Nn \l__fantasycal_base_number_days_of_months_seq { , } ) 
          }
      }
  }



%
% week ~ labels
%

\tikzset
  {
    weekday ~ label ~ above/.style=
      {
        print-weekdays = true ,
        execute ~ before ~ day ~ scope=
          {
            \ifdateT{day ~ of ~ month=1}
              {
                {
                  \pgfmathsetlength{\pgf@y}{\l__fantasycal_draw_day_yshift_tl}
                  \pgftransformyshift{0.5\pgf@y + 1\baselineskip}
                  \pgfmathsetlength{\pgf@xa}{\l__fantasycal_draw_day_xshift_tl}
                  \pgftransformxshift{0.5\pgf@xa}
                  \int_step_inline:nn { \l__fantasycal_base_nr_days_per_week_int }
                    {
                      \tl_set:Nx \l_fantasycal_base_current_day_tl { \int_eval:n {##1} }
                      \l__fantasycal_code_week_day_tl
                      \pgftransformxshift{\pgf@xa}
                    }
                }
              } 
          }
        ,
        every ~ weekday/.append ~ style={anchor=base~#1}
      }
      ,
   weekday ~ label ~ above / .default = { } ,
  }


%
% month ~ labels
%



\tikzset
  {
    month ~ label ~ left/.style=
      {
        execute ~ before ~ day ~ scope=
          {
            \ifdateT {day ~ of ~ month = 1} { \l__fantasycal_code_month_tl }
          }
        ,
        every ~ month/.append ~ style={anchor=base ~ east, xshift=-3.5ex}
      }
  }

\tikzset
  {
    month ~ label ~left ~ vertical/.style=
      {
        execute ~ before ~ day ~ scope=
          {
            \ifdateT {day ~ of ~ month=1} { \l__fantasycal_code_month_tl } 
          } ,
        every ~ month/.append ~ style=
          { anchor=base ~ east , xshift=-4.5ex , yshift=2.25ex , rotate=90 }
      }
  }

\tikzset
  {
    month ~ label ~ right/.style=
      {
        print-monthnames ,
        execute ~ before ~ day ~ scope=
          {
            \ifdateT{day ~ of ~ month=1}
              {
                {
                  \pgfmathsetlength{\l__fantasycal_tmpa_dim}{\l__fantasycal_draw_day_xshift_tl}
                  \pgftransformxshift{\l__fantasycal_draw_width_tl \l__fantasycal_tmpa_dim}
                  \pgftransformxshift{-\l__fantasycal_tmpa_dim}
                  \l__fantasycal_code_month_tl
                }
              }
          }
        ,
        every ~ month/.append ~ style={ anchor=base ~ west , xshift=1ex }
    }
  }

\tikzset
  {
    month ~ label ~ right ~ vertical/.style=
      {
        execute ~ before ~ day ~ scope=
          {
            \ifdateT{day ~ of ~ month=1}
              {
                {
                  \pgfmathsetlength{\l__fantasycal_tmpa_dim}{\l__fantasycal_draw_day_xshift_tl}
                  \pgftransformxshift{\l__fantasycal_draw_width_tl\l__fantasycal_tmpa_dim}
                  \pgftransformxshift{-\l__fantasycal_tmpa_dim}
                  \l__fantasycal_code_month_tl%
                }
              }
          }
        ,
        every ~ month/.append ~ style=
          { anchor=base ~ west , xshift=2ex , yshift=2.25ex , rotate=-90 }
    }
  }




\tikzset
  {
    month ~ label ~ above ~ centered/.style=
      {
        print-monthnames ,
        execute ~ before ~ day ~ scope=
          {
            \ifdateT {day ~ of ~ month=1}
              {
                {
                  \pgfmathsetlength{\pgf@xa}{\l__fantasycal_draw_day_xshift_tl}
                  \pgf@xb=\l__fantasycal_draw_width_tl\pgf@xa%
                  \pgf@xb=.5\pgf@xb%
                  \pgftransformxshift{\pgf@xb}
                  % y-stuff
                  \pgfmathsetlength{\pgf@y}{\l__fantasycal_draw_day_yshift_tl}
                  \bool_if:NTF \l__fantasycal_draw_weekday_bool
                    { \pgftransformyshift { 0.5\pgf@y + 2.25\baselineskip } }
                    { \pgftransformyshift { 0.5\pgf@y + 1\baselineskip } }
                  \l__fantasycal_code_month_tl
                }
              } 
          }
        ,
        every ~ month/.append ~ style={anchor=base}
      }
  }

\tikzset
  {
    month ~ label ~ above ~ left/.style=
      {
        print-monthnames ,
        execute ~ before ~ day ~ scope=
          {
            \ifdateT {day ~ of ~ month=1}
              {
                {
                  \pgfmathsetlength{\pgf@y}{\l__fantasycal_draw_day_yshift_tl}
                  \bool_if:NTF \l__fantasycal_draw_weekday_bool
                    { \pgftransformyshift { 0.5\pgf@y + 2.25\baselineskip } }
                    { \pgftransformyshift { 0.5\pgf@y + 1\baselineskip } }
                  \l__fantasycal_code_month_tl%
                }
              } 
          }
        ,
        every ~ month/.append ~ style={anchor=base ~ west}
      }
  }



\tikzset
  {
    month ~ label ~ above ~ right/.style=
      {
        print-monthnames ,
        execute ~ before ~ day ~ scope=
          {
            \ifdateT {day ~ of ~ month=1}
              {
                {
                  \pgfmathsetlength{\pgf@xa}{\l__fantasycal_draw_day_xshift_tl}
                  \pgf@xb=\l__fantasycal_draw_width_tl\pgf@xa%
                  \pgftransformxshift{\pgf@xb}
                  \pgfmathsetlength{\pgf@y}{\l__fantasycal_draw_day_yshift_tl}
                  \bool_if:NTF \l__fantasycal_draw_weekday_bool
                    { \pgftransformyshift { 0.5\pgf@y + 2.25\baselineskip } }
                    { \pgftransformyshift { 0.5\pgf@y + 1\baselineskip } }
                  \l__fantasycal_code_month_tl%
                }
              } 
          }
        ,
        every ~ month/.append ~ style={anchor=base ~ east}
      }
  }

\tikzset
  {
    month ~ label ~ below ~ centered/.style=
      {
        execute ~ before ~ day ~ scope=
          {
            \ifdateT {day ~ of ~ month=1}
              {
                {
                  \pgfmathsetlength{\pgf@xa}{\l__fantasycal_draw_day_xshift_tl}
                  \pgf@xb=\l__fantasycal_draw_width_tl\pgf@xa%
                  \advance\pgf@xb by-\pgf@xa%
                  \pgf@xb=.5\pgf@xb%
                  \pgftransformxshift{\pgf@xb}
                  \pgftransformxshift{-1.5ex}
                  \pgfmathsetlength{\pgf@y}{\l__fantasycal_draw_day_yshift_tl}
                  \pgftransformyshift{-1.25\pgf@y}
                  \l__fantasycal_code_month_tl%
                }
              } 
          }
        ,
        every ~ month/.append ~ style={anchor=base}
      }
  }

\tikzset
  {
    month ~ label ~ below ~ left/.style=
      {
        execute ~ before ~ day ~ scope=
          {
            \ifdateT {day ~ of ~ month=1}
              {
                {
                  \pgfmathsetlength{\pgf@y}{\l__fantasycal_draw_day_yshift_tl}
                  \pgftransformyshift{-1.25\pgf@y}
                  \l__fantasycal_code_month_tl%
                }
              }
          }
        ,
      every ~ month/.append ~ style={ anchor=base ~ west}
    }
  }










\tl_new:N \l__fantasycal_print_moons_tl
\seq_new:N \l__fantasycal_moon_seq

\NewDocumentCommand \NewFantasyMoon { m m m }
  {
    \DefineNewMoon #1 {#2} {#3}
    \seq_push:Nx \l__fantasycal_moon_seq { \cs_to_str:N #1 }
    \tl_put_right:Nn \l__fantasycal_print_moons_tl
      { #1 { \l_fantasycal_base_current_ordinal_int } \, }
  }

\tikzset
  {
    , add ~ moons / .is ~ choice
    , add ~ moons / true / .code =
       {
         \tl_set:Nn \l__fantasycal_text_day_moon_hook_tl 
           { \, \fantasycalPrintMoons }
       }
    , add ~ moons / false / .code =
       { \tl_clear:N \l__fantasycal_text_day_moon_hook_tl }
    , add ~ moons / .default = true
  }

\cs_new:Npn \fantasycalPrintMoons
  { \l__fantasycal_print_moons_tl }

\pgfset
  {
    all-moons/.code=
      {
        \group_begin:
        \seq_map_inline:Nn \l__fantasycal_moon_seq
          {
            \bool_set_false:N \l__fantasycal_base_date_match_bool
            \str_case:nnF {#1}
              {
                { full } { \pgfqkeys { /pgf } { ##1 = full-moon } }
                { new } { \pgfqkeys { /pgf } { ##1 = new-moon } }
                { half-1 } { \pgfqkeys { /pgf } { ##1 = half-moon-1 } }
                { half-2 } { \pgfqkeys { /pgf } { ##1 = half-moon-2 } }
              }
              { \tl_show:n { ERROR-#1-##1 } }
            %% If even one is false, break the loop
            \bool_if:NF \l__fantasycal_base_date_match_bool { \seq_map_break: }
          }
        \bool_if:NTF \l__fantasycal_base_date_match_bool
          { \group_end: \bool_set_true:N \l__fantasycal_base_date_match_bool }
          { \group_end: }
      }
  }























\NewDocumentCommand \FantasyCalendarDateEntry { m m }
  {
    \__fantasycal_add_yearly_day:nn {#1} {#2}
  }
\NewDocumentCommand \FantasyCalendarOneTimeEntry { m m }
  {
    \__fantasycal_add_one_year_day:nn {#1} {#2}
  }

\cs_new:Npn \__fantasycal_add_yearly_day_parse:w #1-#2\relax
  {
    \tl_set:Nx \l__fantasycal_tmpa_tl { \int_eval:n {#1} - \int_eval:n {#2} }
  }
\cs_new:Npn \__fantasycal_add_one_year_day_parse:w #1-#2-#3\relax
  {
    \tl_set:Nx \l__fantasycal_tmpa_tl { \int_eval:n {#1} - \int_eval:n {#2} - \int_eval:n {#3} }
  }

\cs_new:Npn \__fantasycal_note_put_right:nnn #1#2#3
  {
    \tl_if_exist:cTF { l__fantasycal_ #1 _ #2 _tl }
      { \tl_put_right:cn { l__fantasycal_ #1 _ #2 _tl } { \\ #3 } }
      { 
        \tl_new:c { l__fantasycal_ #1 _ #2 _tl }
        \tl_set:cn { l__fantasycal_ #1 _ #2 _tl } {#3}
      }
  }
\cs_generate_variant:Nn \__fantasycal_note_put_right:nnn { nV }

\cs_new:Npn \__fantasycal_add_yearly_day:nn #1#2
  {
    \tl_set:Nx \l__fantasycal_tmpa_tl {#1}
    \exp_after:wN 
    \__fantasycal_add_yearly_day_parse:w \l__fantasycal_tmpa_tl \relax
    \__fantasycal_note_put_right:nVn { yearly_day } \l__fantasycal_tmpa_tl {#2}
  }
\cs_new:Npn \__fantasycal_add_one_year_day:nn #1#2
  {
    \tl_set:Nx \l__fantasycal_tmpa_tl {#1}
    \exp_after:wN
    \__fantasycal_add_one_year_day_parse:w \l__fantasycal_tmpa_tl \relax
    \__fantasycal_note_put_right:nVn { one_year_day } \l__fantasycal_tmpa_tl {#2}
  }

\NewDocumentCommand \FantasyCalendarSpecialEntry { m m }
  {
    \tikzset
      {
        execute ~ at ~ begin ~ day ~ scope = 
          { 
            \ifdateT {#1} 
              { \__fantasycal_add_yearly_day:nn { \%md } {#2} } 
          }
      }
  }



\tikzset
  {
    , add ~ day ~ notes / .is ~ choice
    , add ~ day ~ notes / true / .code =
       {
         \tl_set:Nn \l__fantasycal_text_day_note_hook_tl \fantasycalPrinDayNotes
       }
    , add ~ day ~ notes / false / .code =
       { \tl_clear:N \l__fantasycal_text_day_note_hook_tl }
    , add ~ day ~ notes / .default = true
  }
\tl_set:Nn \l__fantasycal_font_notes_tl { \small }
\cs_new:Npn \fantasycalPrinDayNotes
  {
    \l__fantasycal_font_notes_tl
    \tl_if_exist:cT { l__fantasycal_yearly_day_ \%md _tl }
      {
        \\ \textsf { \tl_use:c { l__fantasycal_yearly_day_ \%md _tl } }
      }
    \tl_if_exist:cT { l__fantasycal_one_year_day_ \%yd _tl }
      {
        \\ \tl_use:c { l__fantasycal_one_year_day_ \%yd _tl }
      }
  }




\int_new:N \l__fantasycal_task_ordinal_start_int
\int_new:N \l__fantasycal_task_ordinal_end_int
\int_new:N \l__fantasycal_task_color_tl
\int_new:N \l__fantasycal_task_linewidth_tl
\int_new:N \l__fantasycal_task_priority_tl


\clist_new:N \l__fantasycal_task_priorities_clist
\clist_set:Nn \l__fantasycal_task_priorities_clist
  { immediately, high, medium, low }
\clist_map_inline:Nn \l__fantasycal_task_priorities_clist
  {
    \tl_new:c { l__fantasycal_task_ #1 _draw_tl }
  }

\keys_define:nn { fantasycal/task }
  {
    color .tl_set:N = \l__fantasycal_task_color_tl ,
    linewidth .tl_set:N = \l__fantasycal_task_linewidth_tl ,
    done .code:n = { \tl_set:Nn \l__fantasycal_task_priority_tl { done } } ,
    priority .choices:xn = 
      { \l__fantasycal_task_priorities_clist , done }
      {
        \tl_set:NV \l__fantasycal_task_priority_tl \l_keys_choice_tl
        \int_case:nn { \l_keys_choice_int }
          {
            { 1 } { \keys_set:nn { fantasycal/task } { color=red, linewidth=very ~ thick } }
            { 2 } { \keys_set:nn { fantasycal/task } { color=orange, linewidth=  thick } }
            { 3 } { \keys_set:nn { fantasycal/task } { color=blue, linewidth = semithick } }
            { 4 } { \keys_set:nn { fantasycal/task } { color=black, linewidth=thin } }
          }
      }
   ,
  }


\int_new:N \g__fantasycal_task_number_int
\int_new:N \l__fantasycal_task_local_number_int
\int_new:N \l__fantasycal_task_text_printed_int

\dim_new:N \l__fantasycal_task_yshift_dim

\prop_new:N \g__fantasycal_task_used_numbers_prop

\tl_new:N \l__fantasycal_text_task_tl
\tl_set:Nn \l__fantasycal_text_task_tl { \vfill }

%\tikzset
%  {
%    execute ~ before ~ day ~ scope = 
%      { 
%      }
%  }

\NewDocumentCommand \FantasyCalendarAddTask { m m m m }
  {
    \int_gincr:N \g__fantasycal_task_number_int
    \__fantasycal_add_task_setup:Vn \g__fantasycal_task_number_int {#3}
    \str_if_eq:VnF \l__fantasycal_task_priority_tl { done }
      {
        \__fantasycal_base_iso_to_ordinal:nN {#1} \l__fantasycal_task_ordinal_start_int
        \__fantasycal_base_iso_to_ordinal:nN {#2} \l__fantasycal_task_ordinal_end_int
        \__fantasycal_add_task_with_deadlines:VVnVV 
          \l__fantasycal_task_ordinal_start_int \l__fantasycal_task_ordinal_end_int
          {#4} \l__fantasycal_task_color_tl \l__fantasycal_task_linewidth_tl
      }
  }

\cs_new:Npn \__fantasycal_add_task_setup:nn #1#2
  {
    \tl_new:c { l__fantasycal_task_ #1 _text_tl }
    \tl_new:c { l__fantasycal_task_ #1 _draw_tl }
    \int_new:c { l__fantasycal_task_ #1 _shift_int }
    \int_set:cn { l__fantasycal_task_ #1 _shift_int } { -1 }
    \tl_set:Nn \l__fantasycal_task_color_tl { black }
    \tl_clear:N \l__fantasycal_task_linewidth_tl
    \tl_set:Nn \l__fantasycal_task_priority_tl { medium }
    \keys_set:nn { fantasycal/task } {#2}
  }  
\cs_generate_variant:Nn \__fantasycal_add_task_setup:nn { Vn }
        

\cs_new:Npn \__fantasycal_add_task_with_deadlines:nnnnn #1#2#3#4#5
  {
    \__fantasycal_task_save_save:V \g__fantasycal_task_number_int
    \__fantasycal_task_save_text:VnnV \g__fantasycal_task_number_int
      {#2} {#3} \l__fantasycal_task_color_tl
    \__fantasycal_task_save_draw:Vnnx \g__fantasycal_task_number_int
      {#1} {#2} { \l__fantasycal_task_color_tl , \l__fantasycal_task_linewidth_tl }
  }
\cs_generate_variant:Nn \__fantasycal_add_task_with_deadlines:nnnnn { VVnVV }


\cs_new:Npn \__fantasycal_task_save_save:n #1
  {
    \tl_put_right:cn { l__fantasycal_task_ \l__fantasycal_task_priority_tl _draw_tl } 
      { \tl_use:c { l__fantasycal_task_ #1 _draw_tl } }
    \tl_put_right:Nn \l__fantasycal_text_task_tl
      { \tl_use:c { l__fantasycal_task_ #1 _text_tl } }
  }
\cs_generate_variant:Nn \__fantasycal_task_save_save:n { V }


\cs_new:Npn \__fantasycal_task_save_text:nnnn #1#2#3#4
  {
    \tl_set:cn { l__fantasycal_task_ #1 _text_tl }
      {
        \ifdateT { ordinal ~ equals = {#2} }
          { \textcolor {#4} {#3} \\ }
      }
  }
\cs_generate_variant:Nn \__fantasycal_task_save_text:nnnn { VnnV }

\cs_new:Npn \__fantasycal_task_save_draw:nnnn #1#2#3#4
  {
    \tl_set:cn { l__fantasycal_task_ #1 _draw_tl }
      {
        \ifdateTF { ordinal ~ between = { #2 and #3 } }
          { 
            \__fantasycal_task_draw_main:nnnn {#1} {#2} {#3} {#4}
          }{ 
            \ifdateF { ordinal ~ at ~ most = {#3} }
              {
                %% Remove
                \prop_gremove:Nn \g__fantasycal_task_used_numbers_prop {#1}
                \tl_gclear:c { l__fantasycal_task_ #1 _text_tl }
                \tl_gclear:c { l__fantasycal_task_ #1 _draw_tl }
              }
          }
      }
  }
\cs_generate_variant:Nn \__fantasycal_task_save_draw:nnnn { Vnnx }



%% Maybe plan for a whole month ahead.
\cs_new:Npn \__fantasycal_task_draw_main:nnnn #1#2#3#4
  {
    \bool_set_false:N \l_tmpa_bool
    \int_compare:nNnT { \use:c { l__fantasycal_task_ #1 _shift_int } } < { 0 }
      { 
        \bool_set_false:N \l_tmpa_bool
        \int_zero:N \l__fantasycal_tmpa_int
        \bool_do_until:Nn \l_tmpa_bool
          {
            \prop_map_inline:Nn \g__fantasycal_task_used_numbers_prop
              {
                \int_compare:nNnT {##2} = { \l__fantasycal_tmpa_int }
                  { \prop_map_break:n { \use_none:nn } }
              }
            \bool_set_true:N \l_tmpa_bool
            \bool_if:NF \l_tmpa_bool { \int_incr:N \l__fantasycal_tmpa_int }
          }
        \int_gset_eq:cN { l__fantasycal_task_ #1 _shift_int } \l__fantasycal_tmpa_int
        \prop_gput:NnV \g__fantasycal_task_used_numbers_prop
          {#1} \l__fantasycal_tmpa_int
      }
    \int_set_eq:Nc \l__fantasycal_task_local_number_int
      { l__fantasycal_task_ #1 _shift_int }
    \int_set:Nn \l__fantasycal_tmpa_int { 5*\l__fantasycal_task_local_number_int }
    \dim_set:Nn \l__fantasycal_task_yshift_dim 
      { 5mm + \l__fantasycal_tmpa_int\pgflinewidth }
    \ifdateTF { ordinal ~ equals = {#3} }
      { \__fantasycal_task_finish_line:nnn {#4} { } { } }
      { \__fantasycal_task_draw_line:nnn {#4} { } { } }
  }



\cs_new:Npn \__fantasycal_task_draw_line:nnn #1#2#3
  {
    \draw 
      [ #1, #2, #3 , transform ~ canvas = { yshift=-\l__fantasycal_task_yshift_dim } ]
      (\__fantasycal_base_suggested_name: - box.north ~ west) --
      (\__fantasycal_base_suggested_name: - box.north ~ east);
  }
\cs_new:Npn \__fantasycal_task_finish_line:nnn #1#2#3
  {
    \dim_set:Nn \l__fantasycal_tmpa_dim 
      { 
        \l__fantasycal_draw_day_yshift_tl 
          - \l__fantasycal_task_yshift_dim 
          - \l__fantasycal_box_inner_y_sep_dim 
          - \l__fantasycal_task_text_printed_int\baselineskip
      }
    \dim_set:Nn \l__fantasycal_tmpb_dim 
      { 
        \l__fantasycal_draw_day_xshift_tl - 2\l__fantasycal_box_inner_x_sep_dim 
          - \l__fantasycal_tmpa_int\pgflinewidth
      }
    \draw [#1,#2,#3]
        %% Start is north west corner - yshift
        (\__fantasycal_base_suggested_name: - box.north ~ west) 
        ++ (0,-\l__fantasycal_task_yshift_dim) 
        %% draw line to not-quite right corner
        -- ++ (\l__fantasycal_tmpb_dim,0) 
        %% and go down
        -- ++ (0,-\l__fantasycal_tmpa_dim)
        ;
    \int_incr:N \l__fantasycal_task_text_printed_int
  }

\cs_new:Npn \__fantasycal_task_save:nNN #1#2#3
  {
    \tl_new:c { l__fantasycal_task_ \int_use:N \g__fantasycal_task_number_int _text_tl }
    \tl_new:c { l__fantasycal_task_ \int_use:N \g__fantasycal_task_number_int _draw_tl }
  }
\cs_generate_variant:Nn \__fantasycal_add_task_save:nNN { V }


\tl_new:N \l__fantasycal_code_task_tl
\tl_set:Nn \l__fantasycal_code_task_tl
  { 
    \clist_map_inline:Nn \l__fantasycal_task_priorities_clist
      { \tl_use:c { l__fantasycal_task_ #1 _draw_tl } }
  }

%



















\NewDocumentCommand \PrintFantasyCalendarYear { O{} m m }
  {
    \group_begin:
    \fp_set:Nn \l__fantasycal_tmpa_fp {#2}
    \int_step_inline:nn { \l__fantasycal_base_nr_months_per_year_int }
      {
        \noindent
        \tikz\PrintFantasycalendarBase
          [
            , month = \fp_to_int:N \l__fantasycal_tmpa_fp - ##1
            , week ~ list
            , box ~ size = fit
            , box ~ draw = black
            , month ~ label ~ above ~ centered
            , month ~ add ~ number = { \space [\%m0] }
            , weekday ~ label ~ above
            , add ~ moons 
            , add ~ day ~ notes
            , add ~ year ~ to ~ month
            , #1
          ]
          #3
          ;
        \newpage
      }
    \group_end:
  }






%: Calendar
%
% Code of the actual \calendar command (tikz.code.tex contains \let\calendar=\tikz@lib@cal@calendar):
%

\NewDocumentCommand \PrintFantasycalendarBase { }
  {
    \__fantasycal_print_fantasycal:
  }

\cs_new:Npn \__fantasycal_print_fantasycal: 
  {
    \begingroup
      \bool_set_false:N \l__fantasycal_draw_weekday_bool
      \cs_set_eq:NN \__fantasycal_print_if_s: \c_empty_tl
      \tikz@resetexpandcount
      \tikzset{name=,at={(0,0)}}
      \cs_set_eq:NN \% \__fantsycalendar_shorthand:nn
      \tikzset{every ~ calendar/.try}
      \__fantasycal_print_scanner:
  }

\cs_new:Npn \__fantasycal_print_scanner: 
  {
    \afterassignment \__fantasycal_print_handler:
    %% gets next token in input stream
    \let \pgf@let@token =
  }

\cs_new:Npn \__fantasycal_print_handler:
  {
    \pgfutil@switch \pgfutil@ifx \pgf@let@token
      {%
        { ; }{ \let\pgfutil@next\__fantasycal_print_stop: }
        { ( }{ \let\pgfutil@next\__fantasycal_print_name: }  %)
        { a }{ \let\pgfutil@next\__fantasycal_print_at: }
        { [ }{ \let\pgfutil@next\__fantasycal_print_option: } %]
        { i }{ \let\pgfutil@next\__fantasycal_print_if: }
      }
      { \tikz@resetexpandcount \pgfutil@next }
      { \__fantasycal_print_expand: }
  }
  
\cs_new:Npn \__fantasycal_print_expand:
  {
    \int_decr:N \tikz@expandcount
    \int_compare:nNnTF { \tikz@expandcount } < { 0 }
      {
        \tikzerror{Giving up on this calendar}
        \let\pgfutil@next=\tikz@lib@cal@end%
      }{
        \let\pgfutil@next=\__fantasycal_print_expand_auxi:
      }
    \pgfutil@next
  }

\cs_new:Npn \__fantasycal_print_expand_auxi:
  {
    \exp_after:wN \__fantasycal_print_scanner: \pgf@let@token
  }


\cs_new:Npn \__fantasycal_print_name: #1) 
  {
    \tikzset{name=#1}
    \__fantasycal_print_scanner:
  }
\cs_new:Npn \__fantasycal_print_at: t #1 (#2)
  {
    \tikzset{at={(#2)}}
    \__fantasycal_print_scanner:
  }
% [
\cs_new:Npn \__fantasycal_print_option: #1] 
  {
    \tikzset {#1}
    \__fantasycal_print_scanner:
  }
\cs_new:Npn \__fantasycal_print_if: f #1 (#2)
  {
    \pgfutil@ifnextchar [ 
      { \__fantasycal_print_if_opt: {#2} }
      { \__fantasycal_print_if_code: {#2} }
  }

\cs_new:Npn \__fantasycal_print_if_opt: #1 [#2] 
  {
    \__fantasycal_print_if_code: {#1} { \tikzset{#2} }
  }
\cs_new:Npn \__fantasycal_print_if_code: #1#2
  {
    \pgfutil@ifnextchar e
      { \__fantasycal_print_if_else: {#1} {#2} }
      { \__fantasycal_print_if_else: {#1} {#2} else { } }
  }

\cs_new:Npn \__fantasycal_print_if_else: #1 #2 else
  {
    \pgfutil@ifnextchar [ 
      { \__fantasycal_print_if_else_opt: {#1} {#2} }
      { \__fantasycal_print_if_else_code: {#1} {#2} }
  }
\cs_new:Npn  \__fantasycal_print_if_else_opt: #1 #2 [#3]
  {
    \__fantasycal_print_if_else_code:
      {#1} {#2} { \tikzset{#3} }
  }
\cs_new:Npn \__fantasycal_print_if_else_code: #1 #2 #3 
  {
    \exp_args:NNo \cs_set:Npn  \__fantasycal_print_if_s:
      { 
        \__fantasycal_print_if_s:
        \ifdateTF {#1} {#2} {#3} 
      }
    \__fantasycal_print_scanner:
  }



\cs_new:Npn \__fantasycal_print_stop:
  {
    \__fantasycal_calculate_box_size:
    \pgftransformshift { \tikz@node@at }
    \exp_args:NV \__fantasycal_base_fantasycalendar:nnnn 
      \tikz@fig@name 
      { \l__fantasycal_dates_start_tl }
      { \l__fantasycal_dates_end_tl }
      {
        \l__fantasycal_before_day_tl
        \scope%
          \l__fantasycal_at_begin_day_tl
          \__fantasycal_print_if_s:
          \l__fantasycal_code_box_tl
          \l__fantasycal_code_task_tl
          \l__fantasycal_code_day_tl
          \l__fantasycal_at_end_day_tl
        \endscope%
        \l__fantasycal_after_day_tl
      }
    \endgroup
  }


\tikzset{ 
  if /.code=
    {
      \cs_set_eq:NN \__fantasycal_print_scanner_orig: \__fantasycal_print_scanner:
      \cs_set_eq:NN \__fantasycal_print_scanner: \relax
      \__fantasycal_print_if: f #1\relax
      \cs_set_eq:NN \__fantasycal_print_scanner: \__fantasycal_print_scanner_orig:
  }
}









\ExplSyntaxOff
\makeatother


\endinput